<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>marcle.ai admin</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="admin-page">
  <header class="site-header">
    <div class="header-inner">
      <a href="/" class="wordmark">marcle<span class="dot">.</span>ai</a>
      <nav class="header-nav">
        <a href="/#systems" class="nav-link">systems</a>
        <a href="/#status" class="nav-link">status</a>
        <a href="/admin" class="nav-link">admin</a>
      </nav>
    </div>
  </header>

  <main class="admin-wrap">
    <header class="admin-page-header">
      <h1 class="admin-page-title">Admin · Service Configuration</h1>
      <p class="admin-page-subtitle">Runtime operations console · changes apply immediately</p>
    </header>

    <section class="admin-health-widget" aria-label="Live health preview">
      <div class="admin-health-item">
        <span class="admin-health-label">Overall</span>
        <span id="admin-health-overall" class="admin-status-badge unknown">Unknown</span>
      </div>
      <div class="admin-health-item">
        <span class="admin-health-label">Counts</span>
        <div class="admin-health-counts">
          <span id="admin-health-count-healthy" class="admin-chip admin-chip-success">H 0</span>
          <span id="admin-health-count-degraded" class="admin-chip admin-health-chip-degraded">Dg 0</span>
          <span id="admin-health-count-down" class="admin-chip admin-health-chip-down">Dn 0</span>
          <span id="admin-health-count-unknown" class="admin-chip admin-chip-muted">U 0</span>
        </div>
      </div>
      <div class="admin-health-item">
        <span class="admin-health-label">Cache age</span>
        <span id="admin-health-cache-age" class="admin-inline">—</span>
      </div>
      <div class="admin-health-item">
        <span class="admin-health-label">Updated</span>
        <span id="admin-health-updated-at" class="admin-inline">—</span>
      </div>
      <p id="admin-health-note" class="admin-health-note">Fetching public health preview…</p>
    </section>

    <div id="admin-error" class="admin-alert is-hidden" role="alert" aria-live="polite"></div>

    <section class="admin-panel admin-panel-auth" aria-labelledby="admin-auth-heading">
      <div class="admin-panel-heading">
        <h2 id="admin-auth-heading" class="admin-section-title" data-step="1">Authentication</h2>
        <span id="auth-status-indicator" class="admin-chip admin-chip-muted">Not connected</span>
      </div>
      <p class="admin-panel-description">Cloudflare Access plus bearer token is required for all write operations.</p>

      <label class="admin-label" for="admin-token">Admin Token (required)</label>
      <input id="admin-token" class="admin-input" type="password" autocomplete="off" placeholder="Bearer token">
      <p class="admin-help">This token is never stored. It is required for each admin action.</p>
      <p id="auth-connection-detail" class="admin-inline">No successful admin requests yet.</p>

      <div class="admin-actions-row">
        <button id="load-services-btn" class="admin-button" type="button" disabled>Load services</button>
      </div>
    </section>

    <section class="admin-panel admin-panel-services" aria-labelledby="admin-services-heading">
      <div class="admin-panel-heading">
        <h2 id="admin-services-heading" class="admin-section-title" data-step="2">Service List</h2>
        <p id="service-list-meta" class="admin-inline">No services loaded.</p>
      </div>
      <p class="admin-panel-description">Current runtime configuration with public-health preview per service.</p>

      <div class="admin-table-wrap">
        <table class="admin-table">
          <thead>
            <tr>
              <th scope="col" class="admin-col-select">Sel</th>
              <th scope="col">Name</th>
              <th scope="col">Group</th>
              <th scope="col">Health</th>
              <th scope="col">Enabled</th>
              <th scope="col">Auth</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody id="service-list-body">
            <tr>
              <td class="admin-empty" colspan="7">Load services to begin.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="admin-panel admin-panel-bulk" aria-labelledby="admin-bulk-heading">
      <div class="admin-panel-heading">
        <h2 id="admin-bulk-heading" class="admin-section-title" data-step="3">Bulk Actions</h2>
        <p id="bulk-selection-meta" class="admin-inline">No services selected.</p>
      </div>
      <p class="admin-panel-description">Apply enable/disable to multiple selected services.</p>
      <div class="admin-actions-row">
        <button id="bulk-select-all-btn" class="admin-button admin-button-quiet" type="button" disabled>Select all</button>
        <button id="bulk-enable-btn" class="admin-button" type="button" disabled>Enable selected</button>
        <button id="bulk-disable-btn" class="admin-button admin-button-danger-ghost" type="button" disabled>Disable selected</button>
      </div>
    </section>

    <section class="admin-panel admin-panel-notifications" aria-labelledby="admin-notifications-heading">
      <div class="admin-panel-heading">
        <h2 id="admin-notifications-heading" class="admin-section-title" data-step="4">Notifications</h2>
        <div class="admin-actions-row admin-actions-row-inline">
          <p id="notifications-meta" class="admin-inline">Not loaded.</p>
          <button id="notifications-load-btn" class="admin-button admin-button-small admin-button-quiet" type="button" disabled>Load</button>
        </div>
      </div>
      <p class="admin-panel-description">Manage outbound notification targets for incident, recovery, and flapping events.</p>
      <p class="admin-help">Secret values must be set in backend <code>.env</code>; do not paste secrets here.</p>

      <div class="admin-notifications-topbar">
        <label class="admin-checkbox-inline" for="notifications-enabled">
          <input id="notifications-enabled" type="checkbox" disabled>
          <span>Notifications enabled</span>
        </label>
        <div class="admin-actions-row admin-actions-row-inline">
          <button id="notifications-save-btn" class="admin-button admin-button-small" type="button" disabled>Save notifications</button>
          <button id="notifications-test-btn" class="admin-button admin-button-small admin-button-quiet" type="button" disabled>Send Test</button>
        </div>
      </div>

      <p id="notifications-message" class="admin-success is-hidden" role="status" aria-live="polite"></p>

      <div class="admin-table-wrap">
        <table class="admin-table admin-notifications-table">
          <thead>
            <tr>
              <th scope="col">ID</th>
              <th scope="col">URL</th>
              <th scope="col">Events</th>
              <th scope="col">Filters</th>
              <th scope="col">Auth</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody id="notifications-list-body">
            <tr>
              <td class="admin-empty" colspan="6">Authenticate to load notification endpoints.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="admin-panel-heading admin-subpanel-heading">
        <h3 id="notification-form-heading" class="admin-section-title">Add Notification Endpoint</h3>
        <button id="notification-cancel-edit-btn" class="admin-button admin-button-small admin-button-quiet is-hidden" type="button" disabled>Cancel edit</button>
      </div>

      <form id="notification-form" novalidate>
        <fieldset class="admin-fieldset">
          <legend class="admin-legend">Endpoint</legend>
          <div class="admin-grid">
            <div class="admin-field">
              <label class="admin-label" for="notification-id">ID</label>
              <input id="notification-id" class="admin-input" required>
            </div>
            <div class="admin-field">
              <label class="admin-label" for="notification-url">URL</label>
              <input id="notification-url" class="admin-input" required placeholder="https://example.com/webhook">
            </div>
          </div>
        </fieldset>

        <fieldset class="admin-fieldset">
          <legend class="admin-legend">Events</legend>
          <div class="admin-checkbox-grid">
            <label class="admin-checkbox-inline" for="notification-event-incident">
              <input id="notification-event-incident" type="checkbox" checked>
              <span>incident</span>
            </label>
            <label class="admin-checkbox-inline" for="notification-event-recovery">
              <input id="notification-event-recovery" type="checkbox">
              <span>recovery</span>
            </label>
            <label class="admin-checkbox-inline" for="notification-event-flapping">
              <input id="notification-event-flapping" type="checkbox">
              <span>flapping</span>
            </label>
          </div>
        </fieldset>

        <fieldset class="admin-fieldset">
          <legend class="admin-legend">Filters</legend>
          <div class="admin-grid">
            <div class="admin-field">
              <label class="admin-label" for="notification-groups">Groups</label>
              <select id="notification-groups" class="admin-select" multiple size="3">
                <option value="core">core</option>
                <option value="media">media</option>
                <option value="automation">automation</option>
              </select>
            </div>
            <div class="admin-field">
              <label class="admin-label" for="notification-service-ids">Service IDs (comma list)</label>
              <input id="notification-service-ids" class="admin-input" placeholder="proxmox, plex">
            </div>
            <div class="admin-field">
              <label class="admin-label" for="notification-min-severity">Min severity</label>
              <select id="notification-min-severity" class="admin-select">
                <option value="any">any</option>
                <option value="degraded">degraded</option>
                <option value="down">down</option>
              </select>
            </div>
            <div class="admin-field">
              <label class="admin-label" for="notification-cooldown">Cooldown seconds</label>
              <input id="notification-cooldown" class="admin-input" type="number" min="0" step="1" value="0">
            </div>
          </div>
        </fieldset>

        <fieldset class="admin-fieldset">
          <legend class="admin-legend">Auth Ref</legend>
          <div class="admin-grid">
            <div class="admin-field">
              <label class="admin-label" for="notification-auth-scheme">Auth scheme</label>
              <select id="notification-auth-scheme" class="admin-select">
                <option value="none">none</option>
                <option value="bearer">bearer</option>
                <option value="basic">basic</option>
                <option value="header">header</option>
              </select>
            </div>
            <div id="notification-auth-env-wrap" class="admin-field is-hidden">
              <label class="admin-label" for="notification-auth-env">Auth env var name</label>
              <input id="notification-auth-env" class="admin-input" placeholder="DISCORD_WEBHOOK_TOKEN">
            </div>
            <div id="notification-auth-header-wrap" class="admin-field is-hidden">
              <label class="admin-label" for="notification-auth-header">Header name</label>
              <input id="notification-auth-header" class="admin-input" placeholder="X-Api-Key">
            </div>
          </div>
        </fieldset>

        <div class="admin-actions-row">
          <button id="notification-add-btn" class="admin-button" type="submit" disabled>Add endpoint</button>
          <button id="notification-reset-btn" class="admin-button admin-button-quiet" type="button" disabled>Reset form</button>
        </div>
      </form>
    </section>

    <section class="admin-panel admin-panel-audit" aria-labelledby="admin-audit-heading">
      <div class="admin-panel-heading">
        <h2 id="admin-audit-heading" class="admin-section-title" data-step="6">Audit Log</h2>
        <div class="admin-actions-row admin-actions-row-inline">
          <p id="audit-list-meta" class="admin-inline">Not loaded.</p>
          <button id="audit-refresh-btn" class="admin-button admin-button-small admin-button-quiet" type="button" disabled>Refresh</button>
        </div>
      </div>
      <p class="admin-panel-description">Append-only activity log for admin mutations.</p>

      <div class="admin-audit-filters">
        <div class="admin-field">
          <label class="admin-label" for="audit-action-filter">Action</label>
          <select id="audit-action-filter" class="admin-select">
            <option value="">All actions</option>
            <option value="create">create</option>
            <option value="update">update</option>
            <option value="delete">delete</option>
            <option value="toggle">toggle</option>
            <option value="bulk">bulk</option>
          </select>
        </div>
        <div class="admin-field">
          <label class="admin-label" for="audit-search-input">Service filter</label>
          <input id="audit-search-input" class="admin-input" type="search" placeholder="service id">
        </div>
      </div>

      <div class="admin-table-wrap">
        <table class="admin-table admin-audit-table">
          <thead>
            <tr>
              <th scope="col">Time</th>
              <th scope="col">Action</th>
              <th scope="col">Target</th>
              <th scope="col">Details</th>
              <th scope="col">Source</th>
            </tr>
          </thead>
          <tbody id="audit-table-body">
            <tr>
              <td class="admin-empty" colspan="5">Authenticate to load audit entries.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="admin-panel admin-panel-form" aria-labelledby="service-form-heading">
      <div class="admin-panel-heading">
        <h2 id="service-form-heading" class="admin-section-title" data-step="5">Add Service</h2>
        <button id="cancel-edit-btn" class="admin-button admin-button-quiet is-hidden" type="button">Cancel edit</button>
      </div>
      <p class="admin-panel-description">Create or edit service definitions used by the status checker.</p>

      <p id="service-form-mode-note" class="admin-help">Create a new service entry.</p>
      <p id="service-save-message" class="admin-success is-hidden" role="status" aria-live="polite">Service saved.</p>

      <form id="service-form" novalidate>
        <fieldset class="admin-fieldset">
          <legend class="admin-legend">Identity</legend>
          <div class="admin-grid">
            <div class="admin-field">
              <label class="admin-label" for="service-id">ID</label>
              <input id="service-id" name="id" class="admin-input" required aria-describedby="service-id-note service-id-error">
              <p id="service-id-note" class="admin-inline is-hidden">ID cannot be changed while editing.</p>
              <p id="service-id-error" class="admin-field-error" aria-live="polite"></p>
            </div>

            <div class="admin-field">
              <label class="admin-label" for="service-name">Name</label>
              <input id="service-name" name="name" class="admin-input" required aria-describedby="service-name-error">
              <p id="service-name-error" class="admin-field-error" aria-live="polite"></p>
            </div>

            <div class="admin-field">
              <label class="admin-label" for="service-group">Group</label>
              <select id="service-group" name="group" class="admin-select" required aria-describedby="service-group-error">
                <option value="core">core</option>
                <option value="media">media</option>
                <option value="automation">automation</option>
              </select>
              <p id="service-group-error" class="admin-field-error" aria-live="polite"></p>
            </div>
          </div>
        </fieldset>

        <fieldset class="admin-fieldset">
          <legend class="admin-legend">Display</legend>
          <div class="admin-grid">
            <div class="admin-field">
              <label class="admin-label" for="service-icon">Icon</label>
              <input id="service-icon" name="icon" class="admin-input">
              <p id="service-icon-error" class="admin-field-error" aria-live="polite"></p>
            </div>

            <div class="admin-field">
              <label class="admin-label" for="service-description">Description</label>
              <input id="service-description" name="description" class="admin-input">
              <p id="service-description-error" class="admin-field-error" aria-live="polite"></p>
            </div>
          </div>
        </fieldset>

        <fieldset class="admin-fieldset">
          <legend class="admin-legend">Check</legend>
          <div class="admin-grid">
            <div class="admin-field">
              <label class="admin-label" for="service-url">URL</label>
              <input id="service-url" name="url" class="admin-input" required aria-describedby="service-url-error">
              <p id="service-url-error" class="admin-field-error" aria-live="polite"></p>
            </div>

            <div class="admin-field">
              <label class="admin-label" for="service-check-type">Check type</label>
              <input id="service-check-type" name="check_type" class="admin-input" required aria-describedby="service-check-type-error">
              <p id="service-check-type-error" class="admin-field-error" aria-live="polite"></p>
            </div>
          </div>
        </fieldset>

        <fieldset class="admin-fieldset">
          <legend class="admin-legend">Auth</legend>
          <div class="admin-grid">
            <div class="admin-field">
              <label class="admin-label" for="service-auth-scheme">Auth scheme</label>
              <select id="service-auth-scheme" name="auth_scheme" class="admin-select" aria-describedby="service-auth-scheme-error">
                <option value="none">none</option>
                <option value="bearer">bearer</option>
                <option value="basic">basic</option>
                <option value="header">header</option>
              </select>
              <p id="service-auth-scheme-error" class="admin-field-error" aria-live="polite"></p>
            </div>

            <div id="service-auth-env-wrap" class="admin-field is-hidden">
              <label class="admin-label" for="service-auth-env">Auth env var name</label>
              <input id="service-auth-env" name="auth_env" class="admin-input" placeholder="PROXMOX_API_TOKEN" aria-describedby="service-auth-env-error">
              <p id="service-auth-env-error" class="admin-field-error" aria-live="polite"></p>
            </div>

            <div id="service-auth-header-wrap" class="admin-field is-hidden">
              <label class="admin-label" for="service-auth-header-name">Header name</label>
              <input id="service-auth-header-name" name="auth_header_name" class="admin-input" placeholder="X-Api-Key" aria-describedby="service-auth-header-name-error">
              <p id="service-auth-header-name-error" class="admin-field-error" aria-live="polite"></p>
            </div>
          </div>

          <p class="admin-help">Set secret values in backend <code>.env</code> under the env var names above.</p>
        </fieldset>

        <div class="admin-actions-row">
          <button id="save-service-btn" class="admin-button" type="submit" disabled>Add service</button>
          <button id="reset-service-form-btn" class="admin-button admin-button-quiet" type="button" disabled>Reset form</button>
        </div>
      </form>
    </section>
  </main>

  <div id="delete-modal-backdrop" class="admin-modal-backdrop is-hidden" hidden style="display:none;">
    <div id="delete-modal" class="admin-modal" role="dialog" aria-modal="true" aria-labelledby="delete-modal-title" aria-describedby="delete-modal-message">
      <h3 id="delete-modal-title" class="admin-modal-title">Delete service</h3>
      <p id="delete-modal-message" class="admin-modal-message"></p>
      <div class="admin-actions-row admin-modal-actions">
        <button id="delete-cancel-btn" class="admin-button admin-button-quiet" type="button">Cancel</button>
        <button id="delete-confirm-btn" class="admin-button admin-button-danger" type="button">Delete service</button>
      </div>
    </div>
  </div>

  <script src="admin.js"></script>
</body>
</html>
